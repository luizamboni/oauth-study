<svg xmlns="http://www.w3.org/2000/svg" width="1280" height="480" viewBox="0 0 1280 480">
  <rect width="1280" height="480" fill="#ffffff"/>
  <style>
    .actor { fill: #f0f4f8; stroke: #1f3a5f; stroke-width: 1.5; }
    .lifeline { stroke: #7b8ba4; stroke-dasharray: 6 6; stroke-width: 1.2; }
    .arrow { stroke: #1976d2; stroke-width: 2; marker-end: url(#arrowhead); fill: none; }
    .arrow-return { stroke: #388e3c; stroke-width: 2; marker-end: url(#arrowhead-return); fill: none; stroke-dasharray: 6 4; }
    .label { font-family: "Helvetica Neue", Arial, sans-serif; font-size: 14px; fill: #1f2a44; }
    .title { font-weight: 600; font-size: 18px; fill: #102542; }
    .step { font-size: 13px; fill: #102542; }
  </style>
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#1976d2"/>
    </marker>
    <marker id="arrowhead-return" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#388e3c"/>
    </marker>
  </defs>

  <text x="640" y="40" text-anchor="middle" class="title label">Authorization Code Grant with PKCE</text>

  <!-- Actors -->
  <rect class="actor" x="80" y="80" width="160" height="44" rx="6"/>
  <text class="label" x="160" y="108" text-anchor="middle">End User</text>

  <rect class="actor" x="300" y="80" width="180" height="44" rx="6"/>
  <text class="label" x="390" y="108" text-anchor="middle">Browser</text>

  <rect class="actor" x="540" y="80" width="240" height="44" rx="6"/>
  <text class="label" x="660" y="108" text-anchor="middle">OAuth Client (localhost:3000)</text>

  <rect class="actor" x="820" y="80" width="210" height="44" rx="6"/>
  <text class="label" x="925" y="108" text-anchor="middle">Keycloak</text>

  <rect class="actor" x="1090" y="80" width="180" height="44" rx="6"/>
  <text class="label" x="1180" y="108" text-anchor="middle">Protected API</text>

  <!-- Lifelines -->
  <line class="lifeline" x1="160" y1="124" x2="160" y2="440"/>
  <line class="lifeline" x1="390" y1="124" x2="390" y2="440"/>
  <line class="lifeline" x1="660" y1="124" x2="660" y2="440"/>
  <line class="lifeline" x1="925" y1="124" x2="925" y2="440"/>
  <line class="lifeline" x1="1180" y1="124" x2="1180" y2="440"/>

  <!-- Steps -->
  <text class="step" x="275" y="140">1. Click "Start Authorization Code + PKCE"</text>
  <path class="arrow" d="M160 160 L390 160"/>

  <text class="step" x="525" y="190">2. Browser requests /login</text>
  <path class="arrow" d="M390 200 L660 200"/>

  <text class="step" x="660" y="240">3. Client generates code verifier, challenge, and state</text>

  <text class="step" x="790" y="280">4. Redirect browser to Keycloak authorization endpoint</text>
  <path class="arrow" d="M660 280 L925 280"/>

  <text class="step" x="640" y="320">5. User authenticates on Keycloak</text>
  <path class="arrow" d="M925 320 L390 320"/>

  <text class="step" x="790" y="340">6. Keycloak redirects back with authorization code</text>
  <path class="arrow-return" d="M925 340 L660 340"/>

  <text class="step" x="790" y="360">7. Client exchanges code + PKCE verifier for tokens</text>
  <path class="arrow" d="M660 360 L925 360"/>
  <path class="arrow-return" d="M925 370 L660 370"/>

  <text class="step" x="660" y="390">8. Client stores tokens and updates session</text>

  <text class="step" x="850" y="410">9. Client calls Protected API with Bearer token</text>
  <path class="arrow" d="M660 400 L1180 400"/>

  <text class="step" x="980" y="440">10. API validates token with Keycloak</text>
  <path class="arrow" d="M1180 430 L925 430"/>
  <path class="arrow-return" d="M925 440 L1180 440"/>

  <text class="step" x="850" y="460">11. API returns secured response to client</text>
  <path class="arrow-return" d="M1180 450 L660 450"/>
</svg>
